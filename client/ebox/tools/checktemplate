#!/bin/sh

awk '
BEGIN {
	in_args = 0         # Inside an argument tag
	in_attr = 0         # Inside an attributes tag
	in_init = 0         # Inside an init tag
        in_perl = 0         # Inside a perl tag
	print "use strict;"
}

{
	if ($0 ~ /^<\/%args>/)
	{
		in_args = 0
		next
	}
	if ($0 ~ /^<\/%attr>/)
	{
		in_attr = 0
		next
	}
	if ($0 ~ /^<\/%init>/)
	{
		in_init= 0
		next
	}
        if ($0 ~ /^<\/%perl>/)
        {
                in_perl = 0
                next
        }
	if (in_args == 1)
	{
		print "my " $1 ";"
		next
	}
	if (in_init == 1)
	{
		print
		next
	}
        if (in_perl == 1) 
        {
                print
                next
        }
	if ($0 ~ /^<%args>/)
	{
		in_args = 1
		next
	}
	if ($0 ~ /^<%attr>/)
	{
		in_attr = 1
		next
	}
	if ($0 ~ /^<%init>/)
	{
		in_init = 1
		next
	}
        if ($0 ~ /^<%perl>/)
	{
		in_perl = 1
		next
	}
	if (in_args == 0 && in_perl == 0 && in_attr == 0)
	{
		perlline = ($0 ~ /^%/)
		if (perlline)
		{
			print substr($0,2)
			next
		}
		if ($0 ~ /<%.*%>/)
		{
			str = $0
			sub(/^.*?<%/,"",str)
			gsub(/(\|.*?)?%>.*?<%/,";",str)
			sub(/(\|.*?)?%>.*?$/,";",str)
			print str
		}
	}
}
' $1 > /tmp/$$.pl

perl -c /tmp/$$.pl
