<chapter id="ch-trafficshaping">
  <title>Traffic shaping</title>
  <section id="sect-tshaping">
    <title>Introduction</title>
    <para>
      The traffic shaping module allows you to add rules and establish policies
      which will help you to do a more efficient use of the Internet connections.
    </para>
    <para>
     You will be able to set boundaries for protocols and services on your
     network. That is, you could, for example, set a maximum download or upload
     rate for certain services such as ssh, http and so forth.
    </para>
  </section>
  
  <section id="sect-ts-requirements">
   <title>Requirements</title>
    <para>
     In order to use the traffic shaping module, eBox must be placed as your
     gateway in your network. That means your installation will have to fulfil
     the following requirements: 
     <itemizedlist>
     	<listitem>
	At least two network interfaces. One of them connected your local
	network, and another one marked as external.
	</listitem>
	<listitem>
	At least one gateway which must be accessible from your external
	interface. Also, it is necessary to introduce the bandwidth data for
	your configured router. That information must be accurate as it is used
	by the traffic shaping module to compute and control which rates and
	values are within the valid working range.
	</listitem>
     </itemizedlist>
    </para>
  </section>

  <section id="sect-management">
   <title>Management</title>
   <section id="sect-interface">
    <title>Interface selection</title>
    <para>
      Traffic shaping is applied on a per-interface basis. The behaviour depends
      on the sort of interface you shape on. If we select  external interfaces,
      the shaping takes place on the traffic coming out from eBox 
      to the Internet.  On the other hand, shaping on internal interfaces 
      affects to traffic coming in from the Internet. This is very
      important when the source and destination values are set. For
      example, if you want to shape the downloading from a single
      host, you may set its host address in destination not in
      source. On the other hand, if you want to shape its uploading
      rate, you may set its address on the source value.
    </para>
   </section>
   <section id="sect-rules">
    <title>Rules</title>
    <section id="sec-match">
     <title>Matching packets</title>
     <para>
      Once you have selected the network interface, it is time to decide
      which traffic you would like to shape. To do so, we will add rules.
     </para>
     <para>
      The first three lines of the rule will be used to match traffic. 
      That is, they will be used as a selector for traffic.
     </para>
      <variablelist>
       <varlistentry>
        <term>Service</term>
	 <listitem>
	 	<para>
		 This field is used to match a certain protocol. Note that
		 depending on the protocol you pick, you will have to
		 add more extra data to complete the match. For example,
		 if you select TCP, a new field labelled as Port will pop up.
		 You could either leave it blank to match any port or type
		 certain port.
		</para>
	 </listitem>
       </varlistentry>
       <varlistentry>
        <term>Source</term>
	 <listitem>
	 	<para>
		 Source is used to match packets based on their origin. The
		 first thing you will have to do is selecting from the combo box
		 what kind of data you will use to match. You have several
		 options:
		</para>
		<formalpara>
		 <title>Source IP</title> 
		 <para>
		  You can introduce an IP or leave it blank to match any IP.
		 </para>
		</formalpara>
		<formalpara>
		 <title>Source object</title> 
		  <para>
		   You can select one of the
		    objects available in eBox. The different members which
		    compose an object will be used to match traffic. 
		  </para>
		</formalpara>
		<formalpara>
		<title>Source MAC</title>
		  <para>
		   You can introduce a MAC
		   address to match traffic. Note that this option only makes
		   sense when you are adding rules to an external interface, as
		   you have information about your MAC source addresses 
		   belonging to your local network.
		  </para>
		</formalpara>

	  </listitem>
       </varlistentry>
       <varlistentry>
        <term>Destination</term>
	 <listitem>
	 	<para>
		 Destination is used to match packets based on their
		 destination. The steps to take are similar to those for
		 <emphasis>Source</emphasis>. First of all, you have to pick an
		 option from the combo box to tell the system which sort of data
		 will be used to carry out the match for the current rule.
		</para>
		<formalpara>
		 <title>Destination IP</title> 
		 <para>
		  You can introduce an IP or leave it blank to match any IP.
		 </para>
		</formalpara>
		<formalpara>
		 <title>Destination object</title> 
		  <para>
		   You can select one of the
		    objects available in eBox. The different members which 
		    compose an object will be used to match traffic. 
		  </para>
		</formalpara>
	 </listitem>
       </varlistentry>
      </variablelist>
    </section>

   <section id="sect-decision">
    <title>Shaping decision</title>
    <para>
     Let's recap. In the first three lines of a rule you have selected the kind
     of traffic you would like to shape. The next step consists of deciding what
     we would like to do with that traffic. For example, if we are managing a
     protocol which is very critical for the normal working of our business, it is
     quite likely that we would like to prioritise it, or set a minimum quality
     of service for it.
    </para>
    <para>
     The last three lines of  a rule <emphasis>priority, guaranteed rate, and
     maximum rate</emphasis> are used to make that kind of decision. Let us walk
     through them to give you a bit of background.
    </para>

    <variablelist>
     <varlistentry>
      <term>Priority</term>
      <listitem>
       <para>
        This field is used to enqueue network packets in different queues with
	different priorities. Priority ranges from 0 to 7, the smaller priority
	number, the higher priority. Using this field for different services,
	destination or source addresses is a good method to establish your
	prioritasing policy for your network traffic. It is an easy way of
	assure more priortiity for those services which are critical for your
	organisation and relegate those  which are not.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Guaranteed rate</term>
      <listitem>
       <para>
        This field tells eBox which should be the minimum rate for the traffic
	matching the current rule. The rate ranges from 60 kbits to your
	connection bandwidth. 
	<para>
	You have to take into account two important things. eBox will not allow
	you to set a guaranteed rate which is impossible to achieve given your
	connection bandwidth, as usual, if you are adding rules to your external
	interface you are dealing with your upload capacity, in case of your
	internal interface, download capacity. 
	If you set the guaranteed rate to zero, you are
	telling eBox not to assure anything, and it will just do a best-effort
	for that kind of traffic.
	</para>
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Maximum rate</term>
      <listitem>
       <para>
        If the <emphasis>guaranteed rate</emphasis> field sets a lower 
	boundary for the rate, this field can be used to put a ceiling on
	the upload or download rate that (your matched by the rule) traffic can
	reach.
       </para>
       <para>
        By setting this field to zero, you are telling eBox not to set any
	ceiling.
       </para>
      </listitem>
     </varlistentry>


    </variablelist>

   </section>

   </section>
  </section>
</chapter>
