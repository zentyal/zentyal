#!/bin/bash

db_name="zentyal"
db_user="zentyal"

create_db()
{
    NO_PASSWD=0
    PASSWD_FILE='/var/lib/zentyal/conf/zentyal-mysql.passwd'

    # Do not disable innodb if there are other databases previous to the
    # creation of the Zentyal one
    lines=$(echo "show databases" | mysql --defaults-file=/etc/mysql/debian.cnf | wc -l)
    if [ $lines -gt 5 ]
    then
        sed -i 's/innodb = off/innodb = on/' /etc/mysql/conf.d/zentyal.cnf
    fi

    if [ -s $PASSWD_FILE ]
    then
        PASSWD=`cat $PASSWD_FILE`
    else
        PASSWD=`tr -dc A-Za-z0-9 < /dev/urandom | head -c8`
        echo -n $PASSWD > $PASSWD_FILE
        chmod 400 $PASSWD_FILE
        NO_PASSWD=1
    fi

    echo "Creating the $db_name database"
    echo "CREATE DATABASE $db_name;
          GRANT ALL ON $db_name.* TO '$db_user'@'localhost' IDENTIFIED BY \"$PASSWD\";
          FLUSH PRIVILEGES;" | mysql --defaults-file=/etc/mysql/debian.cnf

    perl -MEBox -MEBox::Util::SQL -e'EBox::init(); EBox::Util::SQL::createCoreTables(); 1';

    if [ $NO_PASSWD == 1  ]; then
        mysqladmin -u root password "$PASSWD"
    fi
}

if ! [ -d /var/lib/mysql/$db_name ]; then
    create_db
    touch /var/lib/zentyal/.db-created
fi

