#!/usr/bin/perl

use Parallel::ForkManager;

use constant THREADS => 6;

my $argc = $#ARGV + 1;
if ($argc == 0) {
    print "Usage: $0 <command> [module1 module2 module3 ...]\n\n";
    exit;
}
my $command = shift;

my @modules = ();

if ($argc == 1) {
    opendir(DIR, "./");
    @modules = readdir(DIR);
} else {
    @modules = @ARGV;
}

my $pm = new Parallel::ForkManager(THREADS);

foreach my $module (@modules) {
    if( -d $module and $module ne "." and $module ne ".." and $module ne "debs-ppa") {
        $pm->start and next; # do the fork
        system("zentyal-package", $module) == 0 or die "Building $module failed";
        $pm->finish; # do the exit in the child process
    }
}
$pm->wait_all_children;

print "Done.\n"
