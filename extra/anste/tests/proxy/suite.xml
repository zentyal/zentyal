<?xml version="1.0" encoding="UTF-8"?>
<suite>
    <name>eBox Proxy tests</name>
    <desc>
    Contains a set of tests to check
    that the eBox HTTP Proxy module works properly.
    </desc>

    <scenario>proxy.xml</scenario>

    <test type="selenium">
        <name>EnableModules</name>
        <desc>
        Enable network and firewall modules.
        </desc>

        <host>ebox-server</host>
        <dir>enable-modules</dir>
    </test>

    <test type="selenium">
        <name>ConfigNetworkSetExternal</name>
        <desc>
        Sets the interface as external.
        </desc>

        <host>ebox-server</host>
        <dir>set-external</dir>
        <var name="IFACE" value="eth2"/>
    </test>

    <test type="selenium">
        <name>ConfigProxyFilter</name>
        <desc>
        Config the proxy with filter mode.
        </desc>

        <host>ebox-server</host>
        <dir>set-global-policy</dir>
        <var name="POLICY" value="Filter"/>
    </test>

    <test type="selenium">
        <name>ForbidHost</name>
        <desc>
        Forbid a host.
        </desc>

        <host>ebox-server</host>
        <dir>forbid-host</dir>
        <var name="HOST" value="marca.com"/>
    </test>

    <test>
        <name>FilterAllowDownload</name>
        <desc>Try to download a file of an allowed host</desc>

        <host>test-client</host>
        <dir>test-allow</dir>
        <var name="HOST" value="www.google.com"/>
    </test>
    <test type="selenium">
        <name>TestLogFilterAllowDownload</name>
        <desc>Tests if proxy logs works ok</desc>

        <host>ebox-server</host>
        <dir>test-logs</dir>
        <var name="URL" value="www.google.com"/>
        <var name="EVENT" value="Accepted"/>
    </test>

    <test>
        <name>FilterForbidDownload</name>
        <desc>Try to download a file of a forbidden host</desc>

        <host>test-client</host>
        <dir>test-filter-deny</dir>
        <var name="HOST" value="www.marca.com"/>
    </test>
    <test type="selenium">
        <name>TestLogFilterForbidDownload</name>
        <desc>Tests if proxy logs works ok</desc>

        <host>ebox-server</host>
        <dir>test-logs</dir>
        <var name="URL" value="www.marca.com"/>
        <var name="EVENT" value="Filtered"/>
    </test>

    <test type="selenium">
        <name>ContentFilterStrict</name>
        <desc>
	    Configure content filter setting its threshold to very strict.
        </desc>

        <host>ebox-server</host>
        <dir>content-filter-strict</dir>
    </test>

    <test>
        <name>AccessAdultContent</name>
        <desc>Try to access adult content with "very strict" filter mode</desc>

        <host>test-client</host>
        <dir>test-filter-deny</dir>
        <var name="HOST" value="www.lupaland.com"/>
    </test>
    <test type="selenium">
        <name>TestLogAdultContent</name>
        <desc>Tests if proxy logs works ok</desc>

        <host>ebox-server</host>
        <dir>test-logs</dir>
        <var name="URL" value="www.lupaland.com"/>
        <var name="EVENT" value="Filtered"/>
    </test>

    <test type="selenium">
        <name>ConfigProxyDeny</name>
        <desc>
        Config the proxy with deny mode.
        </desc>

        <host>ebox-server</host>
        <dir>set-global-policy</dir>
        <var name="POLICY" value="Always deny"/>
    </test>

    <test>
        <name>TestDenyAll</name>
        <desc>Try to access google with deny all mode.</desc>

        <host>test-client</host>
        <dir>test-proxy-deny</dir>
    </test>
    <test type="selenium">
        <name>TestLogDenyAll</name>
        <desc>Tests if proxy logs works ok</desc>

        <host>ebox-server</host>
        <dir>test-logs</dir>
        <var name="URL" value="www.google.com"/>
        <var name="EVENT" value="Denied"/>
    </test>

    <test type="selenium">
        <name>ConfigProxyAllow</name>
        <desc>
        Config the proxy with allow mode.
        </desc>

        <host>ebox-server</host>
        <dir>set-global-policy</dir>
        <var name="POLICY" value="Always allow"/>
    </test>

    <test>
        <name>TestAllowAll</name>
        <desc>Try to access adult content with allow all mode.</desc>

        <host>test-client</host>
        <dir>test-allow</dir>
        <var name="HOST" value="www.lupaland.com"/>
    </test>
    <test type="selenium">
        <name>TestLogAllowAll</name>
        <desc>Tests if proxy logs works ok</desc>

        <host>ebox-server</host>
        <dir>test-logs</dir>
        <var name="URL" value="www.lupaland.com"/>
        <var name="EVENT" value="Accepted"/>
    </test>

    <test type="selenium">
        <name>AddGroupWithUser</name>
        <desc>
        Create a new user and add it to a new group.
        </desc>

        <host>ebox-server</host>
        <dir>add-user-to-group</dir>

        <var name="USERNAME" value="foo"/>
        <var name="PASSWORD" value="foo"/>
        <var name="GROUP" value="proxytest"/>
    </test>

    <test type="selenium">
        <name>ConfigProxyAuthorizeAndAllow</name>
        <desc>
        Config the proxy with authorize and allow mode.
        </desc>

        <host>ebox-server</host>
        <dir>set-global-policy</dir>
        <var name="POLICY" value="Authorize and allow"/>
    </test>

    <test type="selenium">
        <name>AddGroupPolicyAllow</name>
        <desc>
        Add a group policy of Allow within a time period.
        </desc>

        <host>ebox-server</host>
        <dir>add-group-policy</dir>
        <var name="GROUP" value="proxytest"/>
        <var name="POLICY" value="Allow"/>
        <var name="FROM" value="10:00"/>
        <var name="TO" value="11:00"/>
    </test>

    <test>
        <name>TestAuthRequired</name>
        <desc>Try to download without auth and check for error 407.</desc>

        <host>test-client</host>
        <dir>test-auth-required</dir>
        <var name="HOST" value="www.google.com"/>
    </test>

    <test>
        <name>TestChangeDateGroupAllow</name>
        <desc>
			(date 01-01 10:30)
		</desc>

        <host>ebox-server</host>
        <dir>change-date</dir>
        <var name="DATE" value="01011030"/>
    </test>

    <test>
        <name>TestAuthAllow</name>
        <desc>Try to download with auth</desc>

        <host>test-client</host>
        <dir>test-allow</dir>
        <var name="HOST" value="www.google.com"/>
        <var name="USERNAME" value="foo"/>
        <var name="PASSWORD" value="foo"/>
    </test>

    <test>
        <name>TestChangeDateGroupDisallow</name>
        <desc>
			(date 01-01 11:30)
		</desc>

        <host>ebox-server</host>
        <dir>change-date</dir>
        <var name="DATE" value="01011130"/>
    </test>

    <test>
        <name>TestAuthDisallowTime</name>
        <desc>Try to download with auth on forbidden hour</desc>

        <host>test-client</host>
        <dir>test-proxy-deny</dir>
        <var name="HOST" value="www.google.com"/>
        <var name="USERNAME" value="foo"/>
        <var name="PASSWORD" value="foo"/>
    </test>

    <test type="selenium">
        <name>AddGroupWithUser2</name>
        <desc>
        Create a new user and add it to a new group.
        </desc>

        <host>ebox-server</host>
        <dir>add-user-to-group</dir>

        <var name="USERNAME" value="bar"/>
        <var name="PASSWORD" value="bar"/>
        <var name="GROUP" value="proxytestdeny"/>
    </test>

    <test type="selenium">
        <name>AddGroupPolicyDeny</name>
        <desc>
        Add a group policy of Deny.
        </desc>

        <host>ebox-server</host>
        <dir>add-group-policy</dir>
        <var name="GROUP" value="proxytestdeny"/>
        <var name="POLICY" value="Deny"/>
		<!-- these values are not really used but they need to be here -->
<!--        <var name="FROM" value=""/>
        <var name="TO" value=""/> -->
    </test>

    <test>
        <name>TestAuthDisallowUser</name>
        <desc>Try to download with auth on forbidden hour</desc>

        <host>test-client</host>
        <dir>test-proxy-deny</dir>
        <var name="HOST" value="www.google.com"/>
        <var name="USERNAME" value="bar"/>
        <var name="PASSWORD" value="bar"/>
    </test>

    <test type="selenium">
        <name>AddObjectPolicyAllowTime</name>
        <desc>
        Add a object policy of Always allow within a time period.
        </desc>

        <host>ebox-server</host>
        <dir>add-object-policy</dir>
        <var name="OBJECT" value="proxyobject"/>
        <var name="IP" value="192.168.2.2"/>
        <var name="POLICY" value="Always allow"/>
        <var name="FROM" value="09:00"/>
        <var name="TO" value="10:00"/>
    </test>

    <test>
        <name>TestChangeDateObjectAllow</name>
        <desc>
			(date 01-01 09:30)
		</desc>

        <host>ebox-server</host>
        <dir>change-date</dir>
        <var name="DATE" value="01010930"/>
    </test>

    <test>
        <name>TestObjectAllow</name>
        <desc>
			Try to download from a object on an allowed hour.
		</desc>

        <host>test-client</host>
        <dir>test-allow</dir>
        <var name="HOST" value="www.google.com"/>
    </test>

    <test>
        <name>TestChangeDateObjectDisallow</name>
        <desc>
			(date 01-01 08:30)
		</desc>

        <host>ebox-server</host>
        <dir>change-date</dir>
        <var name="DATE" value="01010830"/>
    </test>

    <test>
        <name>TestObjectDeny</name>
        <desc>
			Try to download from a object on an disallowed hour.
		</desc>

        <host>test-client</host>
        <dir>test-proxy-deny</dir>
        <var name="HOST" value="www.google.com"/>
    </test>
</suite>
